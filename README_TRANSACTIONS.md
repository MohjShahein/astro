# توثيق نظام المعاملات المالية في تطبيق الأبراج

## نظرة عامة على نظام المعاملات

يتيح نظام المعاملات المالية في تطبيق الأبراج إمكانية:
- إنشاء وتتبع المعاملات المالية للمستخدمين والمنجمين
- إدارة أرصدة المحافظ الإلكترونية
- معالجة مدفوعات الجلسات الاستشارية
- تنفيذ عمليات شحن الرصيد واسترداد الأموال

## هيكلية البيانات

### مجموعة المعاملات (transactions)

```
transactions/
  {transaction_id}/
    user_id: String          // معرف المستخدم صاحب المعاملة
    amount: Number           // قيمة المعاملة (موجبة للإضافة، سالبة للخصم)
    transaction_type: String // نوع المعاملة (payment, earning, deposit, refund)
    created_at: Timestamp    // وقت إنشاء المعاملة
    session_id: String       // معرف الجلسة إذا كانت المعاملة مرتبطة بجلسة
    session_title: String    // عنوان الجلسة
    other_party_id: String   // معرف الطرف الآخر في المعاملة
    description: String      // وصف المعاملة
    is_paid_session: Boolean // هل المعاملة مرتبطة بجلسة مدفوعة
```

### مجموعة المحافظ (wallets)

```
wallets/
  {user_id}/
    balance: Number        // رصيد المحفظة الحالي
    last_updated: Timestamp // تاريخ آخر تحديث للرصيد
    created_at: Timestamp  // تاريخ إنشاء المحفظة
```

## عملية إنهاء الجلسات المدفوعة

### تدفق العمليات

1. **المستخدم أو المنجم يطلب إنهاء الجلسة**
   - يتم استدعاء دالة `endSession` مع تمرير معرف الجلسة.

2. **التحقق من صحة الجلسة**
   - التأكد من وجود الجلسة وأنها في حالة "نشطة".
   - استرجاع معرفات المستخدم والمنجم وبيانات الجلسة.

3. **حساب المدة والتكلفة**
   - حساب الفترة من وقت بدء الجلسة حتى وقت الإنهاء.
   - تحديد التكلفة الإجمالية بناءً على سعر الدقيقة والمدة الزمنية.

4. **تحديث حالة الجلسة**
   - تعيين حالة معالجة الإنهاء `processing_end = true`.
   - تحديث حالة الجلسة إلى 'completed' مباشرة.
   - تعيين التكلفة الإجمالية والمدة الزمنية في وثيقة الجلسة.

5. **معالجة المعاملات المالية**
   - إنشاء معاملة خصم من محفظة المستخدم.
   - تحديث رصيد محفظة المستخدم.
   - إنشاء معاملة إضافة إلى محفظة المنجم.
   - تحديث رصيد محفظة المنجم.

6. **إرسال الإشعارات**
   - إرسال إشعار للمستخدم بإتمام الجلسة والتكلفة.
   - إرسال إشعار للمنجم بإتمام الجلسة والمبلغ المستحق.

## الدوال الرئيسية

### دالة إنهاء الجلسة (endSession)

تقوم بإنهاء جلسة نشطة وتنفيذ المعاملات المالية المرتبطة بها.

```dart
static Future<void> endSession(String sessionId) async {
  // تنفيذ العمليات اللازمة لإنهاء الجلسة
  // انظر تفاصيل الكود في ملف lib/services/chat_service.dart
}
```

### دالة إنشاء معاملة مالية (createSessionTransaction)

تقوم بإنشاء معاملة مالية وتحديث رصيد المحفظة المرتبطة بها.

```dart
static Future<bool> createSessionTransaction(
  String userId,
  double amount,
  String transactionType, {
  String? sessionId,
  String? sessionTitle,
  String? otherPartyId,
  String? description,
}) async {
  // تنفيذ عمليات إنشاء المعاملة وتحديث الرصيد
  // انظر تفاصيل الكود في ملف lib/services/wallet_service.dart
}
```

## قواعد الأمان في Firestore

لضمان عمل نظام المعاملات المالية بشكل صحيح، يجب تكوين قواعد الأمان في Firestore كما يلي:

```javascript
// Wallets collection
match /wallets/{userId} {
  allow read, write: if isSignedIn();
}

// Transactions collection
match /transactions/{document=**} {
  allow read: if isSignedIn();
  allow create: if isSignedIn();
  allow update, delete: if isAdmin(request.auth.uid);
}
```

## أنواع المعاملات

1. **الدفع (payment)**
   - نوع المعاملة: `payment`
   - القيمة: سالبة (خصم من المستخدم)
   - توصيف: دفع مقابل جلسة استشارية

2. **الربح (earning)**
   - نوع المعاملة: `earning`
   - القيمة: موجبة (إضافة للمنجم)
   - توصيف: أرباح من جلسة استشارية

3. **الإيداع (deposit)**
   - نوع المعاملة: `deposit`
   - القيمة: موجبة (إضافة للمستخدم)
   - توصيف: شحن رصيد المحفظة

4. **الاسترداد (refund)**
   - نوع المعاملة: `refund`
   - القيمة: موجبة (إضافة للمستخدم)
   - توصيف: استرداد قيمة جلسة ملغاة

## معالجة الأخطاء

تم تصميم النظام للتعامل مع الحالات الاستثنائية التالية:

1. **فشل إنشاء المعاملات**
   - تستمر عملية إنهاء الجلسة حتى مع فشل إنشاء المعاملات المالية
   - يتم تسجيل الخطأ في السجلات لمتابعته لاحقًا
   - تعود الدالة `createSessionTransaction` بقيمة `false` في حالة الفشل

2. **أخطاء في قواعد البيانات**
   - تم تبسيط قواعد الأمان في Firestore لتجنب أخطاء الصلاحيات
   - يتم التعامل مع القيم غير المتوقعة مثل `null` أو القيم غير الرقمية

3. **أخطاء في الإشعارات**
   - تُعالج أخطاء إرسال الإشعارات بشكل منفصل لضمان إكمال العمليات الأساسية

## إرشادات التطوير

عند إجراء تعديلات على نظام المعاملات المالية، يرجى مراعاة النقاط التالية:

1. **تسلسل العمليات**
   - يجب دائمًا تحديث حالة الجلسة قبل محاولة إنشاء المعاملات المالية
   - يجب معالجة الأخطاء في كل خطوة دون التأثير على الخطوات الأخرى

2. **التعامل مع الرصيد**
   - التحقق دائمًا من وجود السجلات قبل تحديثها
   - استخدام `SetOptions(merge: true)` عند تحديث المحافظ لتجنب فقدان البيانات

3. **السجلات والمتابعة**
   - توثيق كل خطوة في العملية باستخدام `print`
   - تسجيل القيم قبل وبعد التحديث للتحقق من صحة العمليات الحسابية

## تحديثات ابريل 2025

1. **إعادة هيكلة دالة `endSession`**
   - تم فصل عملية تحديث حالة الجلسة عن عملية إنشاء المعاملات المالية
   - تم تحسين معالجة الأخطاء لضمان إكمال عملية إنهاء الجلسة

2. **تبسيط دالة `createSessionTransaction`**
   - تم تبسيط العملية وإزالة القيود المفرطة
   - تمت إضافة قيمة عائد boolean للإشارة إلى نجاح/فشل العملية

3. **تحديث قواعد الأمان**
   - تم تبسيط قواعد الوصول لمجموعة `transactions` و `wallets`
   - تم إصلاح استدعاء دالة `isAdmin` لتمرير `userId` كمعلمة
